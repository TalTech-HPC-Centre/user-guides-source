name: Build documentation and publish to pages repository
# This action is triggered on push to the main branch.
# It uses an SSH key to push the documentation
# to a branch of the staging repository:
# Settings > Deploy keys > Add deploy key > Check "Allow write access"
# SSH key was set up on staging repository
# and set up as a secret in the current repository settings:
# Settings > Secrets > New repository secret

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v4
        with:
          python-version: '3.7'
      - run: pip install -r requirements.txt
      - name: build documentation
        # sphinx-build -M html <sourcedir> <outputdir>
        run: sphinx-build -b html docs public
      - name: Copy over non sphinx files
        run: |
          cp docs/chemistry/*slurm public/chemistry/
          cp docs/chemistry/*com public/chemistry/
          cp docs/chemistry/*inp public/chemistry/
          cp docs/chemistry/*xyz public/chemistry/
          cp docs/chemistry/*sh public/chemistry/
          cp docs/chemistry/*nw public/chemistry/
          cp docs/chemistry/*pdf public/chemistry/
          cp docs/engineering/*slurm public/engineering/
          cp docs/data-analysis/*slurm public/data-analysis
          cp docs/visualization/fvwm2rc.fvwm2rc public/visualization/
          cp docs/visualization/xsessionrc-x2go.xsessionrc-x2go public/visualization/
          cp docs/lumi/*sh public/lumi
          cp docs/lumi/*py public/lumi
          cp docs/lumi/*slurm public/lumi
      - run: touch public/CNAME && echo "docs-staging.hpc.taltech.ee" > public/CNAME
      - run: touch public/.nojekyll
      - uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
        with:
          source-directory: 'public/'
          destination-github-username: 'TalTech-HPC-Centre'
          destination-repository-name: 'user-guides-staging'
          user-email: hpc-actions@taltech.ee
          target-branch: main
          target-directory: public
